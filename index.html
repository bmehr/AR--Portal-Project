<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>A-Frame AR Ground Rectangle</title>
  <meta name="description" content="A-Frame AR example with a rectangle anchored to the ground.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    /* Basic styling for the AR overlay elements */
    body { margin: 0; overflow: hidden; } /* Ensure no scrollbars interfere with AR */
    #ar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1; /* Ensures it's on top of A-Frame canvas */
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      pointer-events: none; /* Allows clicks to pass through to A-Frame scene if needed */
    }
    #enterARButton {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      margin-bottom: 30px;
      pointer-events: auto; /* Make the button clickable */
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #enterARButton:hover {
      background-color: #0056b3;
    }
    #ar-status {
      color: white;
      background-color: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-family: sans-serif;
      font-size: 14px;
      text-align: center;
      display: none; /* Hidden initially */
    }
  </style>
</head>
<body>
  <div id="ar-overlay">
    <p id="ar-status">Point your camera at a surface.</p>
    <button id="enterARButton">Enter AR</button>
  </div>

  <a-scene
    webxr="optionalFeatures: hit-test, dom-overlay, local-floor; overlayElement: #ar-overlay;"
    renderer="colorManagement: true; physicallyCorrectLights: true;"
    xr-mode-ui="enterARButton: #enterARButton; enabled: true;"
    background="color: #ECEFF1" /* Fallback background color */
  >
    <a-assets>
      </a-assets>

    <a-camera position="0 1.6 0" look-controls="enabled: false"></a-camera>

    <a-light type="ambient" color="#BBB"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.8" position="-0.5 1 1"></a-light>

    <a-entity
      id="reticle"
      ar-hit-test="enabled: false; type: plane; planeOrientation: horizontal; targetEl: self" /* Start with enabled: false */
      visible="false"
    >
      <a-ring
        color="teal"
        radius-inner="0.08"
        radius-outer="0.12"
        rotation="-90 0 0" /* Orient the ring to lie flat on the ground */
        material="shader: flat; transparent: true; opacity: 0.8;"
      ></a-ring>
    </a-entity>

    <a-plane
      id="ground-plane"
      material="color: mediumseagreen; shader: flat; transparent: true; opacity: 0.75;"
      width="0.8"
      height="0.8"
      rotation="-90 0 0"
      position="0 -100 0"
      visible="false"
    ></a-plane>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.querySelector('a-scene');
      const arStatusEl = document.getElementById('ar-status');
      const reticleEl = document.getElementById('reticle');
      const groundPlaneEl = document.getElementById('ground-plane');
      let planePlaced = false;

      function initializeARExperience() {
        console.log('Initializing AR Experience...');

        sceneEl.addEventListener('enter-vr', () => {
          console.log('Attempting to enter VR/AR mode.');
          if (sceneEl.is('ar-mode')) {
            console.log('Successfully entered AR mode.');
            arStatusEl.style.display = 'block';
            arStatusEl.textContent = 'Scanning for surfaces... Point your camera around.';
            
            // Enable ar-hit-test on the reticle now that AR session is active
            if (reticleEl) {
              console.log('Enabling ar-hit-test on reticle.');
              reticleEl.setAttribute('ar-hit-test', 'enabled', true);
              // Reticle visibility will be handled by ar-hit-test component itself
              // when it achieves a hit, because targetEl is 'self'.
            }
          } else {
            console.log('Entered VR mode, not AR mode, or mode detection failed.');
            arStatusEl.textContent = 'Entered VR mode. AR mode may not be supported or enabled.';
            arStatusEl.style.display = 'block';
          }
        });

        sceneEl.addEventListener('exit-vr', () => {
          console.log('Exited VR/AR mode.');
          arStatusEl.style.display = 'none';
          groundPlaneEl.setAttribute('visible', 'false');
          groundPlaneEl.setAttribute('position', '0 -100 0');
          planePlaced = false;
          if (reticleEl) {
            console.log('Disabling ar-hit-test and hiding reticle.');
            reticleEl.setAttribute('ar-hit-test', 'enabled', false);
            reticleEl.setAttribute('visible', 'false'); // Explicitly hide reticle on exit
          }
        });

        reticleEl.addEventListener('ar-hit-test-achieved', (event) => {
          console.log('AR Hit Test Achieved (surface found).');
          // Reticle is made visible by the ar-hit-test component when targetEl: self
          arStatusEl.textContent = 'Surface detected! Tap to place rectangle.'; // Changed message slightly

          // For this example, we'll place the plane on tap, not automatically.
          // If you want to place it automatically, uncomment the placement logic here.
          // For tap-to-place, we'll add a click listener to the scene.
        });
        
        // Tap to place logic
        sceneEl.addEventListener('click', (event) => {
            // Check if we are in AR mode and if the reticle is visible (meaning a surface is found)
            if (sceneEl.is('ar-mode') && reticleEl && reticleEl.getAttribute('visible')) {
                if (!planePlaced) {
                    console.log('Scene clicked, placing ground plane.');
                    const reticlePosition = reticleEl.object3D.position;
                    const reticleQuaternion = reticleEl.object3D.quaternion;

                    groundPlaneEl.object3D.position.copy(reticlePosition);
                    groundPlaneEl.object3D.quaternion.copy(reticleQuaternion);
                    
                    groundPlaneEl.setAttribute('visible', 'true');
                    planePlaced = true;
                    arStatusEl.textContent = 'Rectangle anchored to the ground!';
                    console.log('Ground plane placed at:', reticlePosition);

                    // Optionally hide reticle after placement
                    // reticleEl.setAttribute('visible', 'false');
                    // reticleEl.setAttribute('ar-hit-test', 'enabled', false');
                } else {
                    console.log('Scene clicked, but plane already placed.');
                }
            }
        });


        reticleEl.addEventListener('ar-hit-test-lost', () => {
          console.log('AR Hit Test Lost (surface lost).');
          // Reticle is made invisible by ar-hit-test component
          if (!planePlaced) {
            arStatusEl.textContent = 'No surface detected. Point camera at a surface.';
          } else {
            arStatusEl.textContent = 'Rectangle anchored. Reticle lost surface focus.';
          }
        });
        
        arStatusEl.style.display = 'block';
        arStatusEl.textContent = 'Click "Enter AR" and point your camera at a flat surface.';
        console.log('AR UI Initialized. Waiting for user to click Enter AR.');
      }

      if (sceneEl.hasLoaded) {
        initializeARExperience();
      } else {
        sceneEl.addEventListener('loaded', initializeARExperience);
      }
    });
  </script>
</body>
</html>