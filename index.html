<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>A-Frame AR Ground Rectangle</title>
  <meta name="description" content="A-Frame AR example with a rectangle anchored to the ground.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    /* Basic styling for the AR overlay elements */
    #ar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1; /* Ensures it's on top of A-Frame canvas */
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      pointer-events: none; /* Allows clicks to pass through to A-Frame scene if needed */
    }
    #enterARButton {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      margin-bottom: 30px;
      pointer-events: auto; /* Make the button clickable */
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #enterARButton:hover {
      background-color: #0056b3;
    }
    #ar-status {
      color: white;
      background-color: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-family: sans-serif;
      font-size: 14px;
      text-align: center;
      display: none; /* Hidden initially */
    }
  </style>
</head>
<body>
  <div id="ar-overlay">
    <p id="ar-status">Point your camera at a surface.</p>
    <button id="enterARButton">Enter AR</button>
  </div>

  <a-scene
    webxr="optionalFeatures: hit-test, dom-overlay, local-floor; overlayElement: #ar-overlay;"
    ar-modes="webxr" /* Primarily use WebXR */
    renderer="colorManagement: true; physicallyCorrectLights: true;"
    xr-mode-ui="enterARButton: #enterARButton; anabled: true;" /* Link button to AR mode entry */
    background="color: #ECEFF1" /* Fallback background color */
  >
    <a-assets>
      </a-assets>

    <a-camera position="0 1.6 0" look-controls="enabled: false" ar-camera=""></a-camera>

    <a-light type="ambient" color="#BBB"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.8" position="-0.5 1 1"></a-light>

    <a-entity
      id="reticle"
      ar-hit-test="type: plane; planeOrientation: horizontal; targetEl: self"
      visible="false" /* Starts invisible, ar-hit-test makes it visible on hit */
    >
      <a-ring
        color="teal"
        radius-inner="0.08"
        radius-outer="0.12"
        rotation="-90 0 0" /* Orient the ring to lie flat on the ground */
        material="shader: flat; transparent: true; opacity: 0.8;"
      ></a-ring>
    </a-entity>

    <a-plane
      id="ground-plane"
      material="color: mediumseagreen; shader: flat; transparent: true; opacity: 0.75;"
      width="0.8" /* Size of the rectangle */
      height="0.8"
      rotation="-90 0 0" /* Orient it to lie flat */
      position="0 -100 0" /* Initially hidden far away */
      visible="false"
    ></a-plane>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.querySelector('a-scene');
      const arStatusEl = document.getElementById('ar-status');
      const reticleEl = document.getElementById('reticle');
      const groundPlaneEl = document.getElementById('ground-plane');
      let planePlaced = false;

      // Function to run once the A-Frame scene is loaded
      function initializeARExperience() {
        // Handle entering AR mode
        sceneEl.addEventListener('enter-vr', () => {
          if (sceneEl.is('ar-mode')) {
            arStatusEl.style.display = 'block';
            arStatusEl.textContent = 'Scanning for surfaces... Point your camera around.';
            // Reticle visibility is handled by its ar-hit-test component
          }
        });

        // Handle exiting AR mode
        sceneEl.addEventListener('exit-vr', () => {
          arStatusEl.style.display = 'none';
          groundPlaneEl.setAttribute('visible', 'false'); // Hide plane
          groundPlaneEl.setAttribute('position', '0 -100 0'); // Move it away
          planePlaced = false; // Allow placing again if re-entering AR
          if (reticleEl) reticleEl.setAttribute('visible', 'false'); // Ensure reticle is hidden
        });

        // Listen for when the reticle finds a surface
        reticleEl.addEventListener('ar-hit-test-achieved', (event) => {
          arStatusEl.textContent = 'Surface detected! Reticle active.';
          // The reticleEl is automatically made visible by ar-hit-test.
          // Now, if the main plane hasn't been placed, place it.
          if (!planePlaced) {
            // Get position and rotation from the reticle (which is on the detected surface)
            const reticlePosition = reticleEl.object3D.position;
            const reticleQuaternion = reticleEl.object3D.quaternion;

            // Apply this transform to our ground-plane
            groundPlaneEl.object3D.position.copy(reticlePosition);
            groundPlaneEl.object3D.quaternion.copy(reticleQuaternion);
            
            // Make the ground plane visible
            groundPlaneEl.setAttribute('visible', 'true');
            planePlaced = true;
            arStatusEl.textContent = 'Rectangle anchored to the ground!';

            // Optionally, hide the reticle once the main object is placed
            // reticleEl.setAttribute('visible', 'false');
            // Or keep reticle visible for further interactions if desired.
            // For this example, let's keep it to show where the surface is.
          }
        });

        // Listen for when the reticle loses a surface
        reticleEl.addEventListener('ar-hit-test-lost', () => {
          // ReticleEl is automatically made invisible by ar-hit-test.
          if (!planePlaced) { // Only update status if plane not yet placed
            arStatusEl.textContent = 'No surface detected. Point camera at a surface.';
          } else {
            // If plane is already placed, it remains. Reticle just indicates current tracking.
            arStatusEl.textContent = 'Rectangle anchored. Reticle lost surface focus.';
          }
        });

        // Initial message before entering AR
        arStatusEl.style.display = 'block';
        arStatusEl.textContent = 'Click "Enter AR" and point your camera at a flat surface.';
      }

      // Wait for the A-Frame scene to load before setting up AR events
      if (sceneEl.hasLoaded) {
        initializeARExperience();
      } else {
        sceneEl.addEventListener('loaded', initializeARExperience);
      }
    });
  </script>
</body>
</html>
